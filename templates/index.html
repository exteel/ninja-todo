<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ninja Todo - –®–ª—è—Ö –ù—ñ–Ω–¥–∑—è</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#ff6b2b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ninja Todo">
    <link rel="apple-touch-icon" href="/static/icon-192.png">
</head>
<body>



    <!-- Floating leaves -->
    <div class="particles">
        <div class="leaf leaf-1">üçÉ</div>
        <div class="leaf leaf-2">üçÇ</div>
        <div class="leaf leaf-3">üçÉ</div>
        <div class="leaf leaf-4">üçÇ</div>
        <div class="leaf leaf-5">üçÉ</div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-bg">
            <div class="cloud cloud-1"></div>
            <div class="cloud cloud-2"></div>
            <div class="cloud cloud-3"></div>
        </div>
        <div class="header-content">
            <div class="konoha-symbol">&#x2726;</div>
            <h1>Âøç NINJA TODO</h1>
            <p class="header-sub">–®–ª—è—Ö –Ω—ñ–Ω–¥–∑—è –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ –ø–µ—Ä—à–æ–≥–æ –∫—Ä–æ–∫—É <span class="kanji">ÁÅ´ÂΩ±</span></p>
        </div>
        <div class="header-user">
            <span class="user-name">üë§ {{ user.name }}</span>
            {% if user.is_admin %}
            <a href="{{ url_for('admin_panel') }}" class="admin-btn" title="–ê–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å" target="_blank">üîê</a>
            {% endif %}
            <a href="{{ url_for('logout') }}" class="logout-btn" title="–í–∏–π—Ç–∏">‚èè</a>
        </div>
        <div class="headband">
            <div class="headband-plate">
                <svg class="konoha-svg" viewBox="0 0 100 100" width="22" height="22">
                    <circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4"/>
                    <path d="M50 30 C50 30, 35 50, 50 70 C65 50, 50 30, 50 30" fill="none" stroke="currentColor" stroke-width="3.5"/>
                    <line x1="50" y1="14" x2="50" y2="30" stroke="currentColor" stroke-width="3"/>
                </svg>
            </div>
        </div>
    </header>

    <main class="container">

        <!-- Rank -->
        <div class="rank-badge" id="rankBadge">
            <span class="rank-icon">{{ rank_icon }}</span>
            <span class="rank-text">{{ rank_name }}</span>
        </div>

        <!-- Add form -->
        <form class="add-form" id="addForm">
            <div class="input-row">
                <div class="input-wrapper">
                    <span class="input-kunai">&#x2694;</span>
                    <input type="text" id="todoText" placeholder="–ù–æ–≤–∞ –º—ñ—Å—ñ—è –Ω—ñ–Ω–¥–∑—è..." autocomplete="off" required maxlength="200" />
                    <button type="button" class="voice-btn" id="voiceBtn" onclick="toggleVoice()" title="–ì–æ–ª–æ—Å–æ–≤–∏–π –≤–≤—ñ–¥">
                        <span id="voiceBtnIcon">üé§</span>
                    </button>
                </div>
                <button type="submit" class="btn btn-add">
                    <span class="btn-icon">&#x2726;</span>
                    <span class="btn-label">–ú—ñ—Å—ñ—è!</span>
                </button>
            </div>
            <div class="input-extras">
                <div class="select-wrapper">
                    <label class="extra-label">–†–∞–Ω–≥</label>
                    <select id="todoRank" class="select-rank">
                        {% for r in ranks %}
                        <option value="{{ r }}">{{ r }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="date-wrapper">
                    <label class="extra-label">–î–µ–¥–ª–∞–π–Ω</label>
                    <input type="date" id="todoDeadline" class="input-date" min="{{ today }}" />
                </div>
            </div>
        </form>

        <!-- Search & Filter -->
        <div class="toolbar">
            <div class="search-wrapper">
                <span class="search-icon">üîç</span>
                <input type="text" id="searchInput" class="search-input" placeholder="–ü–æ—à—É–∫ –º—ñ—Å—ñ–π..." value="{{ search }}" />
            </div>
            <div class="filter-tabs">
                <button class="tab {% if current_filter == 'all' %}active{% endif %}" onclick="setFilter('all')">–í—Å—ñ</button>
                <button class="tab {% if current_filter == 'active' %}active{% endif %}" onclick="setFilter('active')">–í –±–æ—é</button>
                <button class="tab {% if current_filter == 'done' %}active{% endif %}" onclick="setFilter('done')">–í–∏–∫–æ–Ω–∞–Ω—ñ</button>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats" id="statsBlock">
            <div class="stat-card">
                <span class="stat-emoji">üìú</span>
                <div class="stat-info">
                    <span class="stat-value" id="statTotal">{{ stats.total }}</span>
                    <span class="stat-label">–ú—ñ—Å—ñ–π</span>
                </div>
            </div>
            <div class="stat-card stat-done">
                <span class="stat-emoji">‚öîÔ∏è</span>
                <div class="stat-info">
                    <span class="stat-value" id="statDone">{{ stats.done }}</span>
                    <span class="stat-label">–í–∏–∫–æ–Ω–∞–Ω–æ</span>
                </div>
            </div>
            <div class="stat-card stat-pending">
                <span class="stat-emoji">üéØ</span>
                <div class="stat-info">
                    <span class="stat-value" id="statPending">{{ stats.pending }}</span>
                    <span class="stat-label">–í –±–æ—é</span>
                </div>
            </div>
        </div>

        <!-- Chakra bar -->
        <div class="chakra-section" id="chakraSection" style="{% if stats.total == 0 %}display:none{% endif %}">
            <div class="chakra-label" id="chakraLabel">–ß–∞–∫—Ä–∞: {{ ((stats.done / stats.total * 100) if stats.total > 0 else 0) | int }}%</div>
            <div class="progress-bar">
                <div class="progress-fill" id="chakraFill" style="width: {{ (stats.done / stats.total * 100) if stats.total > 0 else 0 }}%"></div>
            </div>
        </div>

        <!-- Todo list -->
        <ul class="todo-list" id="todoList">
            {% for todo in todos %}
            <li class="todo-item {% if todo.done %}done{% endif %} rank-{{ todo.rank }}" data-id="{{ todo.id }}" style="animation-delay: {{ loop.index0 * 0.04 }}s">
                <span class="drag-handle" title="–ü–µ—Ä–µ—Ç—è–≥–Ω—É—Ç–∏">&#x2630;</span>
                <button class="todo-checkbox" onclick="toggleTodo({{ todo.id }})" title="–ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å">
                    {% if todo.done %}
                        <span class="check-icon checked">&#x2726;</span>
                    {% else %}
                        <span class="check-icon">&#x25CB;</span>
                    {% endif %}
                </button>
                <div class="todo-content">
                    <span class="todo-text" ondblclick="startEdit({{ todo.id }})">{{ todo.text }}</span>
                    <div class="todo-meta">
                        <span class="todo-rank-badge rank-{{ todo.rank }}">{{ todo.rank }}</span>
                        {% if todo.deadline %}
                        <span class="todo-deadline {% if not todo.done and todo.deadline < today %}overdue{% endif %}">
                            üìÖ {{ todo.deadline }}
                        </span>
                        {% endif %}
                        {% if todo.done %}
                            <span class="todo-status-done">–ó–∞–≤–µ—Ä—à–µ–Ω–æ ‚úì</span>
                        {% endif %}
                    </div>
                    <button class="subtasks-toggle" onclick="toggleSubtasks(event, {{ todo.id }})">
                        <span>&#x25B6;</span> –ü—ñ–¥–∑–∞–¥–∞—á—ñ <span class="subtask-progress" id="sub-progress-{{ todo.id }}"></span>
                    </button>
                    <div class="subtask-progress-bar"><div class="subtask-progress-fill" id="sub-bar-{{ todo.id }}" style="width:0%"></div></div>
                    <div class="subtasks-section" id="subtasks-{{ todo.id }}">
                        <ul class="subtask-list" id="subtask-list-{{ todo.id }}"></ul>
                        <div class="subtask-add-row">
                            <input type="text" class="subtask-input" id="subtask-input-{{ todo.id }}" placeholder="–ù–æ–≤–∞ –ø—ñ–¥–∑–∞–¥–∞—á–∞..." maxlength="200" onkeydown="if(event.key==='Enter')addSubtask({{ todo.id }})" />
                            <button class="subtask-add-btn" onclick="addSubtask({{ todo.id }})">+</button>
                        </div>
                    </div>
                </div>
                <div class="todo-actions">
                    <button class="btn btn-edit" onclick="startEdit({{ todo.id }})" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">‚úé</button>
                    <button class="btn btn-delete" onclick="deleteTodo({{ todo.id }})" title="–í–∏–¥–∞–ª–∏—Ç–∏">&#x2716;</button>
                </div>
            </li>
            {% endfor %}
        </ul>

        <!-- Empty state -->
        {% if not todos %}
        <div class="empty" id="emptyState">
            <div class="empty-icon">üåÄ</div>
            <p>–ú—ñ—Å—ñ–π –ø–æ–∫–∏ –Ω–µ–º–∞—î</p>
            <span class="empty-hint">–î–æ–¥–∞–π —Å–≤–æ—é –ø–µ—Ä—à—É –º—ñ—Å—ñ—é, –Ω—ñ–Ω–¥–∑—è! Dattebayo!</span>
        </div>
        {% endif %}

        <!-- Undo toast -->
        <div class="toast" id="undoToast">
            <span class="toast-text" id="undoText"></span>
            <button class="toast-btn" id="undoBtn" onclick="undoDelete()">‚Ü© –ü–æ–≤–µ—Ä–Ω—É—Ç–∏</button>
            <button class="toast-close" onclick="hideToast()">‚úï</button>
        </div>

    </main>

    <!-- Edit modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <h3>‚úé –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –º—ñ—Å—ñ—é</h3>
                <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editId" />
                <div class="form-group">
                    <label class="form-label">–¢–µ–∫—Å—Ç –º—ñ—Å—ñ—ó</label>
                    <input type="text" id="editText" class="form-input" maxlength="200" />
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">–†–∞–Ω–≥</label>
                        <select id="editRank" class="form-select">
                            <option value="D">D</option>
                            <option value="C">C</option>
                            <option value="B">B</option>
                            <option value="A">A</option>
                            <option value="S">S</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–î–µ–¥–ª–∞–π–Ω</label>
                        <input type="date" id="editDeadline" class="form-input" />
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="closeModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button class="btn btn-save" onclick="saveEdit()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- Confirm modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal modal-sm">
            <div class="modal-header">
                <h3>‚ö†Ô∏è –í–∏–¥–∞–ª–∏—Ç–∏ –º—ñ—Å—ñ—é?</h3>
                <button class="modal-close" onclick="closeConfirm()">‚úï</button>
            </div>
            <div class="modal-body">
                <p class="confirm-text" id="confirmText"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="closeConfirm()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">üóë –í–∏–¥–∞–ª–∏—Ç–∏</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <span>–ó—Ä–æ–±–ª–µ–Ω–æ –≤</span>
        <span class="konoha-text">–ö–æ–Ω–æ—Ö—ñ</span>
        <span>üç•</span>
        <span>–Ω–∞ Flask</span>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
    // ‚îÄ‚îÄ‚îÄ Sound effects ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    let audioCtx;
    function getCtx() {
        if (!audioCtx) audioCtx = new AudioCtx();
        return audioCtx;
    }

    function playSound(type) {
        try {
            const ctx = getCtx();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            gain.gain.value = 0.08;

            if (type === 'add') {
                osc.frequency.setValueAtTime(600, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(900, ctx.currentTime + 0.1);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.2);
                osc.start(); osc.stop(ctx.currentTime + 0.2);
            } else if (type === 'done') {
                osc.frequency.setValueAtTime(500, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.15);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
                osc.start(); osc.stop(ctx.currentTime + 0.3);
            } else if (type === 'undone') {
                osc.frequency.setValueAtTime(400, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(250, ctx.currentTime + 0.15);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.2);
                osc.start(); osc.stop(ctx.currentTime + 0.2);
            } else if (type === 'delete') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(300, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(80, ctx.currentTime + 0.25);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
                osc.start(); osc.stop(ctx.currentTime + 0.3);
            } else if (type === 'error') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(200, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.15);
                osc.start(); osc.stop(ctx.currentTime + 0.15);
            }
        } catch (e) {}
    }

    // ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const today = '{{ today }}';
    let deletedTodo = null;
    let toastTimer = null;
    let pendingDeleteId = null;

    async function fetchJSON(url, opts = {}) {
        const res = await fetch(url, {
            headers: { 'Content-Type': 'application/json' },
            ...opts
        });
        return { ok: res.ok, status: res.status, data: await res.json() };
    }

    function updateStats() {
        fetchJSON('/api/stats').then(({ data }) => {
            document.getElementById('statTotal').textContent = data.total;
            document.getElementById('statDone').textContent = data.done;
            document.getElementById('statPending').textContent = data.pending;
            document.getElementById('rankBadge').innerHTML =
                `<span class="rank-icon">${data.rank_icon}</span><span class="rank-text">${data.rank_name}</span>`;

            const section = document.getElementById('chakraSection');
            if (data.total > 0) {
                section.style.display = '';
                document.getElementById('chakraLabel').textContent = `–ß–∞–∫—Ä–∞: ${data.chakra}%`;
                document.getElementById('chakraFill').style.width = `${data.chakra}%`;
            } else {
                section.style.display = 'none';
            }
        });
    }

    function todoHTML(t) {
        const doneClass = t.done ? 'done' : '';
        const checkIcon = t.done ? '<span class="check-icon checked">&#x2726;</span>' : '<span class="check-icon">&#x25CB;</span>';
        const overdue = (!t.done && t.deadline && t.deadline < today) ? 'overdue' : '';
        const deadlineHTML = t.deadline ? `<span class="todo-deadline ${overdue}">üìÖ ${t.deadline}</span>` : '';
        const statusHTML = t.done ? '<span class="todo-status-done">–ó–∞–≤–µ—Ä—à–µ–Ω–æ ‚úì</span>' : '';

        return `
        <li class="todo-item ${doneClass} rank-${t.rank} todo-enter" data-id="${t.id}">
            <button class="todo-checkbox" onclick="toggleTodo(${t.id})" title="–ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å">${checkIcon}</button>
            <div class="todo-content">
                <span class="todo-text" ondblclick="startEdit(${t.id})">${escapeHTML(t.text)}</span>
                <div class="todo-meta">
                    <span class="todo-rank-badge rank-${t.rank}">${t.rank}</span>
                    ${deadlineHTML}
                    ${statusHTML}
                </div>
                <button class="subtasks-toggle" onclick="toggleSubtasks(event, ${t.id})">
                    <span>&#x25B6;</span> –ü—ñ–¥–∑–∞–¥–∞—á—ñ <span class="subtask-progress" id="sub-progress-${t.id}"></span>
                </button>
                <div class="subtask-progress-bar"><div class="subtask-progress-fill" id="sub-bar-${t.id}" style="width:0%"></div></div>
                <div class="subtasks-section" id="subtasks-${t.id}">
                    <ul class="subtask-list" id="subtask-list-${t.id}"></ul>
                    <div class="subtask-add-row">
                        <input type="text" class="subtask-input" id="subtask-input-${t.id}" placeholder="–ù–æ–≤–∞ –ø—ñ–¥–∑–∞–¥–∞—á–∞..." maxlength="200" onkeydown="if(event.key==='Enter')addSubtask(${t.id})" />
                        <button class="subtask-add-btn" onclick="addSubtask(${t.id})">+</button>
                    </div>
                </div>
            </div>
            <div class="todo-actions">
                <button class="btn btn-edit" onclick="startEdit(${t.id})" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">‚úé</button>
                <button class="btn btn-delete" onclick="deleteTodo(${t.id})" title="–í–∏–¥–∞–ª–∏—Ç–∏">&#x2716;</button>
            </div>
        </li>`;
    }

    function escapeHTML(str) {
        const d = document.createElement('div');
        d.textContent = str;
        return d.innerHTML;
    }

    // ‚îÄ‚îÄ‚îÄ Add todo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.getElementById('addForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = document.getElementById('todoText').value.trim();
        const rank = document.getElementById('todoRank').value;
        const deadline = document.getElementById('todoDeadline').value || null;

        if (!text) return;

        const { ok, data } = await fetchJSON('/api/add', {
            method: 'POST',
            body: JSON.stringify({ text, rank, deadline })
        });

        if (ok) {
            playSound('add');
            const list = document.getElementById('todoList');
            const empty = document.getElementById('emptyState');
            if (empty) empty.remove();

            list.insertAdjacentHTML('afterbegin', todoHTML(data));
            document.getElementById('todoText').value = '';
            document.getElementById('todoDeadline').value = '';
            document.getElementById('todoRank').value = 'D';
            updateStats();
        } else {
            playSound('error');
            alert(data.error || '–ü–æ–º–∏–ª–∫–∞');
        }
    });

    // ‚îÄ‚îÄ‚îÄ Toggle todo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function toggleTodo(id) {
        const { ok, data } = await fetchJSON(`/api/toggle/${id}`, { method: 'POST' });
        if (!ok) return;

        playSound(data.done ? 'done' : 'undone');
        const li = document.querySelector(`[data-id="${id}"]`);
        if (!li) return;

        li.outerHTML = todoHTML(data);
        updateStats();
    }

    // ‚îÄ‚îÄ‚îÄ Delete todo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function deleteTodo(id) {
        const li = document.querySelector(`[data-id="${id}"]`);
        const text = li ? li.querySelector('.todo-text').textContent : '';
        pendingDeleteId = id;
        document.getElementById('confirmText').textContent = `"${text}"`;
        document.getElementById('confirmModal').classList.add('show');
        document.getElementById('confirmDeleteBtn').onclick = () => confirmDelete(id);
    }

    async function confirmDelete(id) {
        closeConfirm();
        const li = document.querySelector(`[data-id="${id}"]`);
        if (li) {
            li.classList.add('todo-exit');
            await new Promise(r => setTimeout(r, 300));
        }

        const { ok, data } = await fetchJSON(`/api/delete/${id}`, { method: 'DELETE' });
        if (!ok) return;

        playSound('delete');
        if (li) li.remove();
        deletedTodo = data.deleted;
        showToast(`–ú—ñ—Å—ñ—é "${data.deleted.text}" –≤–∏–¥–∞–ª–µ–Ω–æ`);
        updateStats();

        if (document.querySelectorAll('.todo-item').length === 0) {
            document.getElementById('todoList').insertAdjacentHTML('afterend',
                '<div class="empty" id="emptyState"><div class="empty-icon">üåÄ</div><p>–ú—ñ—Å—ñ–π –ø–æ–∫–∏ –Ω–µ–º–∞—î</p><span class="empty-hint">–î–æ–¥–∞–π —Å–≤–æ—é –ø–µ—Ä—à—É –º—ñ—Å—ñ—é, –Ω—ñ–Ω–¥–∑—è! Dattebayo!</span></div>');
        }
    }

    // ‚îÄ‚îÄ‚îÄ Undo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showToast(msg) {
        const toast = document.getElementById('undoToast');
        document.getElementById('undoText').textContent = msg;
        toast.classList.add('show');
        clearTimeout(toastTimer);
        toastTimer = setTimeout(hideToast, 5000);
    }

    function hideToast() {
        document.getElementById('undoToast').classList.remove('show');
        clearTimeout(toastTimer);
    }

    async function undoDelete() {
        if (!deletedTodo) return;
        const t = deletedTodo;
        const { ok, data } = await fetchJSON('/api/add', {
            method: 'POST',
            body: JSON.stringify({ text: t.text, rank: t.rank, deadline: t.deadline })
        });
        if (ok) {
            if (t.done) {
                await fetchJSON(`/api/toggle/${data.id}`, { method: 'POST' });
            }
            playSound('add');
            hideToast();
            location.reload();
        }
        deletedTodo = null;
    }

    // ‚îÄ‚îÄ‚îÄ Edit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function startEdit(id) {
        const li = document.querySelector(`[data-id="${id}"]`);
        if (!li) return;

        const text = li.querySelector('.todo-text').textContent;
        const rankBadge = li.querySelector('.todo-rank-badge');
        const rank = rankBadge ? rankBadge.textContent.trim() : 'D';
        const deadlineEl = li.querySelector('.todo-deadline');
        const deadline = deadlineEl ? deadlineEl.textContent.replace('üìÖ', '').trim() : '';

        document.getElementById('editId').value = id;
        document.getElementById('editText').value = text;
        document.getElementById('editRank').value = rank;
        document.getElementById('editDeadline').value = deadline;
        document.getElementById('editModal').classList.add('show');
        document.getElementById('editText').focus();
    }

    function closeModal() {
        document.getElementById('editModal').classList.remove('show');
    }

    async function saveEdit() {
        const id = document.getElementById('editId').value;
        const text = document.getElementById('editText').value.trim();
        const rank = document.getElementById('editRank').value;
        const deadline = document.getElementById('editDeadline').value || null;

        if (!text) {
            playSound('error');
            return;
        }

        const { ok, data } = await fetchJSON(`/api/edit/${id}`, {
            method: 'PUT',
            body: JSON.stringify({ text, rank, deadline })
        });

        if (ok) {
            playSound('add');
            closeModal();
            const li = document.querySelector(`[data-id="${id}"]`);
            if (li) li.outerHTML = todoHTML(data);
        } else {
            playSound('error');
            alert(data.error || '–ü–æ–º–∏–ª–∫–∞');
        }
    }

    function closeConfirm() {
        document.getElementById('confirmModal').classList.remove('show');
    }

    // ‚îÄ‚îÄ‚îÄ Filter & Search (AJAX, no reload) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let currentFilter = '{{ current_filter }}';
    let currentSearch = '{{ search }}';
    let searchTimeout;

    function setFilter(filter) {
        currentFilter = filter;
        document.querySelectorAll('.filter-tabs .tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        loadTodos();
    }

    async function loadTodos() {
        const params = new URLSearchParams({ filter: currentFilter, search: currentSearch });
        const { ok, data } = await fetchJSON('/api/todos?' + params.toString());
        if (!ok) return;

        const list = document.getElementById('todoList');
        const emptyEl = document.getElementById('emptyState');

        if (data.length === 0) {
            list.innerHTML = '';
            if (!emptyEl) {
                list.insertAdjacentHTML('afterend',
                    '<div class="empty" id="emptyState"><div class="empty-icon">üåÄ</div><p>–ú—ñ—Å—ñ–π –ø–æ–∫–∏ –Ω–µ–º–∞—î</p><span class="empty-hint">–î–æ–¥–∞–π —Å–≤–æ—é –ø–µ—Ä—à—É –º—ñ—Å—ñ—é, –Ω—ñ–Ω–¥–∑—è! Dattebayo!</span></div>');
            }
        } else {
            if (emptyEl) emptyEl.remove();
            list.innerHTML = data.map((t, i) => {
                const html = todoHTML(t);
                return html.replace('todo-enter', `todo-enter" style="animation-delay:${i * 0.04}s`);
            }).join('');
        }
        updateStats();
    }

    document.getElementById('searchInput').addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        currentSearch = e.target.value.trim();
        searchTimeout = setTimeout(() => loadTodos(), 400);
    });


    // ‚îÄ‚îÄ‚îÄ Drag & Drop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const todoList = document.getElementById('todoList');
    if (todoList && typeof Sortable !== 'undefined') {
        Sortable.create(todoList, {
            animation: 200,

            draggable: '.todo-item',
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            onEnd: async () => {
                const items = Array.from(todoList.children).map((el, i) => ({
                    id: parseInt(el.dataset.id),
                    position: i
                }));
                await fetchJSON('/api/reorder', {
                    method: 'POST',
                    body: JSON.stringify(items)
                });
            }
        });
    }

    // ‚îÄ‚îÄ‚îÄ Subtasks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const subtasksCache = {};

    async function toggleSubtasks(e, todoId) {
        e.stopPropagation();
        const section = document.getElementById('subtasks-' + todoId);
        const btn = e.currentTarget;
        const arrow = btn.querySelector('span');

        if (section.classList.contains('open')) {
            section.classList.remove('open');
            arrow.innerHTML = '&#x25B6;';
            return;
        }

        section.classList.add('open');
        arrow.innerHTML = '&#x25BC;';
        await loadSubtasks(todoId);
    }

    async function loadSubtasks(todoId) {
        const { ok, data } = await fetchJSON('/api/subtasks/' + todoId);
        if (!ok) return;
        subtasksCache[todoId] = data;
        renderSubtasks(todoId, data);
    }

    function renderSubtasks(todoId, subtasks) {
        const list = document.getElementById('subtask-list-' + todoId);
        if (!list) return;

        list.innerHTML = subtasks.map(s => `
            <li class="subtask-item" data-sub-id="${s.id}">
                <button class="subtask-check ${s.done ? 'done' : ''}" onclick="toggleSubtask(${todoId}, ${s.id})">
                    ${s.done ? '&#x2726;' : '&#x25CB;'}
                </button>
                <span class="subtask-text ${s.done ? 'done' : ''}">${escapeHTML(s.text)}</span>
                <button class="subtask-del" onclick="deleteSubtask(${todoId}, ${s.id})">&#x2716;</button>
            </li>
        `).join('');

        updateSubtaskProgress(todoId, subtasks);
    }

    function updateSubtaskProgress(todoId, subtasks) {
        const total = subtasks.length;
        const done = subtasks.filter(s => s.done).length;
        const pct = total > 0 ? Math.round(done / total * 100) : 0;

        const progress = document.getElementById('sub-progress-' + todoId);
        const bar = document.getElementById('sub-bar-' + todoId);

        if (progress) progress.textContent = total > 0 ? `(${done}/${total})` : '';
        if (bar) bar.style.width = pct + '%';
    }

    async function addSubtask(todoId) {
        const input = document.getElementById('subtask-input-' + todoId);
        const text = input.value.trim();
        if (!text) return;

        const { ok, data } = await fetchJSON('/api/subtasks/' + todoId + '/add', {
            method: 'POST',
            body: JSON.stringify({ text })
        });

        if (ok) {
            playSound('add');
            input.value = '';
            if (!subtasksCache[todoId]) subtasksCache[todoId] = [];
            subtasksCache[todoId].push(data);
            renderSubtasks(todoId, subtasksCache[todoId]);
        } else {
            playSound('error');
        }
    }

    async function toggleSubtask(todoId, subId) {
        const { ok, data } = await fetchJSON('/api/subtasks/toggle/' + subId, { method: 'POST' });
        if (!ok) return;
        playSound(data.done ? 'done' : 'undone');
        if (subtasksCache[todoId]) {
            subtasksCache[todoId] = subtasksCache[todoId].map(s => s.id === subId ? data : s);
            renderSubtasks(todoId, subtasksCache[todoId]);
        }
    }

    async function deleteSubtask(todoId, subId) {
        const { ok } = await fetchJSON('/api/subtasks/delete/' + subId, { method: 'DELETE' });
        if (!ok) return;
        playSound('delete');
        if (subtasksCache[todoId]) {
            subtasksCache[todoId] = subtasksCache[todoId].filter(s => s.id !== subId);
            renderSubtasks(todoId, subtasksCache[todoId]);
        }
    }
    // ‚îÄ‚îÄ‚îÄ Keyboard shortcuts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeModal();
            closeConfirm();
            if (isListening) stopVoice();
        }
        if (e.key === 'Enter' && document.getElementById('editModal').classList.contains('show')) {
            saveEdit();
        }
    });

    // ‚îÄ‚îÄ‚îÄ Voice Input ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let recognition = null;
    let isListening = false;

    function initVoice() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) return null;
        const r = new SpeechRecognition();
        r.lang = 'uk-UA';
        r.continuous = false;
        r.interimResults = true;
        r.maxAlternatives = 1;

        r.onstart = () => {
            isListening = true;
            document.getElementById('voiceBtn').classList.add('listening');
            document.getElementById('voiceBtnIcon').textContent = 'üî¥';
            document.getElementById('todoText').placeholder = '–ì–æ–≤–æ—Ä—ñ—Ç—å...';
        };

        r.onresult = (e) => {
            const transcript = Array.from(e.results)
                .map(r => r[0].transcript).join('');
            document.getElementById('todoText').value = transcript;
            if (e.results[e.results.length - 1].isFinal) {
                stopVoice();
                playSound('add');
            }
        };

        r.onerror = (e) => {
            console.warn('Voice error:', e.error);
            stopVoice();
            if (e.error === 'not-allowed') {
                alert('–î–æ–∑–≤–æ–ª—å—Ç–µ –¥–æ—Å—Ç—É–ø –¥–æ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞ –≤ –±—Ä–∞—É–∑–µ—Ä—ñ!');
            }
        };

        r.onend = () => { stopVoice(); };
        return r;
    }

    function toggleVoice() {
        if (isListening) {
            stopVoice();
        } else {
            startVoice();
        }
    }

    function startVoice() {
        if (!recognition) recognition = initVoice();
        if (!recognition) {
            // iOS fallback - use input focus trick
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            if (isIOS) {
                const input = document.getElementById('todoText');
                input.setAttribute('x-webkit-speech', '');
                input.focus();
                // Show hint
                showVoiceHint();
            } else {
                alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –≥–æ–ª–æ—Å–æ–≤–∏–π –≤–≤—ñ–¥. –°–ø—Ä–æ–±—É–π—Ç–µ Chrome –Ω–∞ –∫–æ–º–ø—é—Ç–µ—Ä—ñ.');
            }
            return;
        }
        try { recognition.start(); } catch(e) {}
    }

    function showVoiceHint() {
        const hint = document.createElement('div');
        hint.className = 'voice-hint-toast';
        hint.innerHTML = 'üé§ –ù–∞ iPhone: —É—Ç—Ä–∏–º—É–π üé§ –Ω–∞ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—ñ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥—É';
        document.body.appendChild(hint);
        setTimeout(() => hint.classList.add('show'), 10);
        setTimeout(() => {
            hint.classList.remove('show');
            setTimeout(() => hint.remove(), 400);
        }, 4000);
    }

    function stopVoice() {
        isListening = false;
        document.getElementById('voiceBtn').classList.remove('listening');
        document.getElementById('voiceBtnIcon').textContent = 'üé§';
        document.getElementById('todoText').placeholder = '–ù–æ–≤–∞ –º—ñ—Å—ñ—è –Ω—ñ–Ω–¥–∑—è...';
        try { if (recognition) recognition.stop(); } catch(e) {}
    }


    </script>

    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/static/sw.js')
                .then(r => console.log('SW registered'))
                .catch(e => console.warn('SW failed:', e));
        });
    }
    </script>
</body>
</html>